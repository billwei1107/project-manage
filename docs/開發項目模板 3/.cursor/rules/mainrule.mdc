---
alwaysApply: true
---
# 代碼規範

## 日誌系統規範

### 開發日誌類型

1. **主開發日誌 (devlog)**
   - 文件名：`devlog`
   - 位置：`devlog/` 目錄
   - 用途：記錄整個項目的開發規劃、整體進度和重要里程碑
   - **開頭格式要求**：
     - 必須在文件開頭明確列出以下信息：
       - 項目名稱
       - 開發時間
       - 開發期限
       - 部署方式
       - 需使用的技術棧
       - 項目完整結構樹

2. **日常開發日誌 (Daily Development Log)**
   - 文件名格式：`yyyy-mm-dd`（例如：`2024-11-18`）
   - 位置：`devlog/` 目錄
   - 用途：記錄每次完成事項的詳細記錄

3. **問題與解決日誌 (Issues and Solutions Log)**
   - 文件名：`問題與解決-devlog`
   - 位置：`devlog/` 目錄
   - 用途：專門記錄遇到的問題和對應的解決方式

### 日誌記錄規則

1. **自動記錄時機**
   - 任務完成時
   - 代碼撰寫完成時
   - 代碼執行完成時
   - 遇到問題時
   - 問題解決時

2. **時間標記格式**
   - 格式：`hh:mm`（例如：`14:30`）
   - 記錄前必須先使用 `%date` 等指令確認當前時間

3. **問題處理流程**
   - 遇到問題時，先查閱 `問題與解決-devlog` 文件
   - 查找是否有類似問題的記錄和解決方案
   - 優先使用已有的解決方案

4. **網關問題記錄規範**
   - 所有與網關相關的問題，除了在項目日誌中記錄外，還必須記錄到網關目錄的問題文檔中
   - 網關問題文檔位置：`/Users/kawa_wei/Desktop/軟體開發mac/11.21程序4896151309233351509尾款3k-論壇app/dev-gateway/網關配置與問題解決.md`
   - 記錄內容包括：問題描述、原因分析、解決方案、驗證步驟、經驗教訓
   - 根據問題情況，同步更新網關目錄下的使用說明文檔
   - 網關使用說明位置：`/Users/kawa_wei/Desktop/軟體開發mac/11.21程序4896151309233351509尾款3k-論壇app/dev-gateway/網關使用說明.md`

4. **日誌存放位置**
   - 所有 devlog 相關文件一律存放在 `devlog/` 目錄中
5. **日誌文件格式**
   - 所有 devlog 日誌文件一律使用 `.md` 擴展名
6. **日誌職責分工**
   - `主devlog` 僅負責記錄所有功能模塊的開發規劃，`日期-devlog` 專責記錄開發過程與進度信息

## 中文使用規範

- 具體使用的語言規範（例如：是否使用簡體中文、繁體中文或其他語言），由當前項目的 `projectrule.mdc` 決定

## 任務管理規範

- 每次接收到任務時，必須先建立任務清單
- 任務清單必須使用中文編寫

## 環境與路徑規範

- 所有腳本、配置與代碼訪問路徑必須通過環境變量傳入，禁止硬編碼絕對路徑
- 訪問文件系統時一律使用相對路徑（以項目根或當前工作目錄爲基準），如需絕對路徑必須由環境變量提供

## 需求管理規範

- 所有需求必須統一記錄在 `需求文檔` 文件中
- 確認需求時僅能從 `需求文檔` 獲取信息，不得引用其他來源
- 閱讀需求後需要先整理理解摘要並向用戶報告，得到確認後方可實際更新 `需求文檔`

## 需求與流程圖規範

- 所有需求文檔一律存放在「需求目錄」中（例如專案根目錄下的 `需求/`），禁止將需求內容分散在其他任意位置
- 每個項目必須準備一個專用的「流程圖目錄」（例如 `需求/流程圖/`），專門存放與需求對應的流程圖文件與匯出圖片
- 在閱讀完需求目錄中的需求文檔後，必須依照需求內容爲每一個功能模塊建立對應的流程圖
- 流程圖應以 Markdown Preview 友善的方式撰寫（例如使用 Markdown 語法與適合在預覽中閱讀的圖示風格），並以文字清楚標示各節點與流程關係
- 流程圖的背景顏色一律設置爲白色，確保匯出圖片在各種介面上都有良好可讀性
- 流程圖中的文字語言必須遵守當前專案的 `projectrule.mdc` 中對語言的規定（例如使用繁體中文或其他指定語言），不得混用未經允許的語言
- 完成流程圖撰寫後，必須將流程圖匯出爲 PNG 圖片，並將所有 PNG 文件統一存放在該專案的「流程圖目錄」中，以便後續查閱與維護

### 頁面結構規範

- 如果項目有頁面結構需求，必須使用樹狀圖（非輻射圖）的方式撰寫頁面結構
- 頁面結構文檔一律存放在 `需求/頁面結構/` 目錄下
- 頁面結構應以 Markdown Preview 友善的方式撰寫（例如使用 Markdown 語法與適合在預覽中閱讀的圖示風格），並以文字清楚標示各頁面層級與關係
- 頁面結構的背景顏色一律設置爲白色，確保匯出圖片在各種介面上都有良好可讀性
- 頁面結構中的文字語言必須遵守當前專案的 `projectrule.mdc` 中對語言的規定（例如使用繁體中文或其他指定語言），不得混用未經允許的語言
- 完成頁面結構撰寫後，必須將頁面結構匯出爲 PNG 圖片，並將 PNG 文件存放在 `需求/頁面結構/` 目錄下，與對應的 Markdown 文件放在同一目錄

### 圖表匯出規範

- 所有流程圖和頁面結構的 Markdown 文件完成後，必須匯出爲 PNG 圖片
- PNG 圖片生成參數統一使用：`-b white -w 7680 -H 4320 -s 4`
  - `-b white`: 背景顏色設置爲白色
  - `-w 7680`: 圖片寬度 7680 像素
  - `-H 4320`: 圖片高度 4320 像素
  - `-s 4`: 縮放比例 4 倍
- PNG 文件必須與對應的 Markdown 文件放在同一目錄下：
  - 流程圖 PNG 文件存放在 `需求/流程圖/` 目錄下
  - 頁面結構 PNG 文件存放在 `需求/頁面結構/` 目錄下

## 代碼註釋規範

- 以每一個功能模塊為單位撰寫註釋，清楚說明該部分的用途與設計思路，而非每一行都必須註釋
- 註釋使用哪種語言、是否需要中英雙語，由當前專案的 `projectrule.mdc` 決定

## 代碼撰寫規範

- 每個文件首行必須寫明該文件用途的註釋，確保快速理解上下文；具體語言與是否需要中英雙語由當前專案的 `projectrule.mdc` 決定
- 嚴禁將所有代碼堆疊在同一作用域，須按功能模塊拆分函數、類或組件以利維護
- 公共邏輯必須提取爲獨立模塊或工具，避免重複實現並利於單元測試
- 每個模塊需遵循單一職責並保持接口清晰，修改一處不應牽動無關功能
- 新增模塊需同步更新文檔與依賴圖，確保團隊瞭解模塊關係與調用邊界

## 依賴管理規範

- 安裝依賴時，在無特殊需求或相容性限制的情況下，一律安裝可用的最新版依賴
- 如因專案需求、部署環境或客戶要求需要鎖定版本，必須在當前項目的 `projectrule.mdc` 或項目文檔中明確說明版本範圍或固定版本

## Git 提交規範

1. **Git 初始化檢查**
   - 每次提交前必須先確認 Git 倉庫是否已初始化
   - 如果未初始化，需要先執行 `git init`

2. **自動提交流程**
   - 每次任務完成時，必須自行執行 Git 提交
   - 提交前需要確認當前時間（使用 `%date` 等指令）

3. **提交消息規範**
   - 提交消息使用上次提交後記錄在日誌中的內容
   - 提交消息需要是中英文，確保清楚記錄變更內容

4. **提交時間記錄**
   - 提交完成後，必須在對應日期的日誌文件中記錄提交時間
   - 記錄格式：在當天的日誌文件中添加提交時間標記（格式：`hh:mm`）

## 開發日誌維護規範

- 標註已完成的部分，保留開發歷史記錄
- 新增未完成的開發進度，不能隨意刪除舊記錄
- 如果有需要補充的內容，可以主動補充，確保開發流程完善

## 開發期限管理規範

1. **期限檢查機制**
   - 每次撰寫代碼前，必須先確認當前時間（使用 `%date` 等指令）並對照開發期限
   - 計算剩餘開發時間與計劃進度，評估是否按計劃進行
   - 如發現進度延遲風險，必須立即向用戶報告並建議調整方案

2. **進度調整建議**
   - 當進度延遲超過計劃時間的 20% 時，建議重新評估任務優先級或調整功能範圍
   - 建議方案包括：調整功能優先級、簡化非核心功能、延長開發期限、增加開發資源等
   - 必須在每次代碼提交時評估進度，並在日誌中記錄進度狀態

3. **定期進度報告**
   - 在開發過程中定期（建議每日）評估進度，記錄在當日的開發日誌中
   - 進度報告需包含：已完成任務、進行中任務、計劃任務、風險預警、建議措施等

## 專案開始規範

- 專案開始前必須詢問用戶是否需要使用開發網關
- 如果用戶確認需要使用網關，則必須在項目根目錄建立指向網關目錄的符號鏈接（軟鏈接）
- 網關目錄位於上一級目錄：`../dev-gateway`
- 符號鏈接名稱：`dev-gateway`

## Docker 開發環境規範

### 1. 統一網關方案避免端口衝突

**問題背景**:
- 開發機可能同時運行多個應用項目（如論壇App、電商系統、博客平臺等）
- 每個項目都需要佔用端口（前端3000、後端8080、數據庫3306等）
- 直接暴露所有服務端口會導致嚴重的端口衝突

**解決方案**:
採用統一網關方案，通過單一入口端口和路徑前綴區分不同項目：

```
開發機架構:
┌─────────────────────────────────────────┐
│         開發機 (Development Machine)      │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │   統一網關 (Unified Gateway)       │ │
│  │   Nginx - Port 80                 │ │
│  │   ├─ /forum    → 論壇項目          │ │
│  │   ├─ /shop     → 電商項目          │ │
│  │   └─ /blog     → 博客項目          │ │
│  └───────────────────────────────────┘ │
│           ↓       ↓       ↓            │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐  │
│  │ 論壇網絡 │ │ 電商網絡 │ │ 博客網絡 │  │
│  │ (內部)  │ │ (內部)  │ │ (內部)  │  │
│  └─────────┘ └─────────┘ └─────────┘  │
└─────────────────────────────────────────┘
```

### 2. Docker 內部網絡配置

**核心原則**:
1. **僅網關暴露端口**:
   - 統一網關容器暴露 80 端口到主機
   - 所有應用項目服務僅在 Docker 內部網絡通信

2. **獨立項目網絡**:
   - 每個項目創建獨立的 Docker 網絡（如 `forum_internal`）
   - 項目內服務加入項目網絡和網關網絡

3. **路徑前綴路由**:
   - 通過 Nginx location 配置路徑前綴（如 `/forum`、`/shop`）
   - 前端應用配置相應的 base 路徑

### 3. 網關配置示例

**網關目錄結構**:
```
~/dev-gateway/
├── docker-compose.yml   # 網關容器編排
├── nginx.conf          # Nginx 配置文件
└── README.md          # 使用說明
```

**Nginx 配置模板**:
```nginx
upstream project_name {
    server project-frontend:5173;
}

server {
    listen 80;
    
    location /project-path {
        proxy_pass http://project_name;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 4. 項目 Docker Compose 配置要點

**網絡配置**:
```yaml
networks:
  # 加入外部網關網絡 / Join external gateway network
  dev_gateway:
    external: true
    name: dev_gateway
  
  # 項目內部網絡 / Project internal network
  project_internal:
    driver: bridge

services:
  frontend:
    networks:
      - project_internal  # 項目內通信
      - dev_gateway       # 網關訪問
    # 不暴露端口到主機
```

### 5. 局域網訪問配置

**要求**:
1. **網關綁定 0.0.0.0**:
   ```yaml
   ports:
     - "0.0.0.0:80:80"  # 允許局域網訪問
   ```

2. **前端開發服務器配置**:
   - Vite: `server: { host: true }`
   - Create React App: `HOST=0.0.0.0`

3. **訪問方式**:
   - 本機訪問: `http://localhost/project-path/`
   - 局域網訪問: `http://[機器IP]/project-path/`
   - 手機訪問: 連接同一WiFi，使用局域網地址

### 6. 常用命令

**創建網關網絡**:
```bash
docker network create dev_gateway
```

**啓動網關**:
```bash
cd ~/dev-gateway && docker-compose up -d
```

**查看機器IP**:
```bash
# macOS
ipconfig getifaddr en0

# Linux
hostname -I | awk '{print $1}'
```

**檢查端口占用**:
```bash
# 檢查80端口是否被佔用
lsof -i :80
netstat -an | grep :80
```

### 7. 網關服務使用規範

**重要原則**:
- 是否需要在本專案中使用開發網關，由當前專案的 `projectrule.mdc` 中的設定決定；若專案未標示需要網關，則可以忽略本節與相關網關配置規範
- 網關實際目錄一律放在專案目錄之外（例如上層的 `../dev-gateway`），專案內不可直接硬編碼絕對路徑
- 若需要使用網關服務，必須通過項目根目錄下的軟鏈接 `dev-gateway` 或相對路徑 `../dev-gateway` 訪問網關配置
- 網關目錄位於項目上一級目錄：`/Users/kawa_wei/Desktop/軟體開發mac/dev-gateway/`
- 項目根目錄下的 `dev-gateway` 是指向網關目錄的軟鏈接

**網關訪問方式**:

1. **通過軟鏈接訪問**:
   ```bash
   # 在項目根目錄下
   cd dev-gateway
   # 或
   ls dev-gateway/
   ```

2. **通過相對路徑訪問**:
   ```bash
   # 在項目根目錄下
   cd ../dev-gateway
   # 或
   ls ../dev-gateway/
   ```

**項目接入網關步驟**:

1. **確保網關網絡存在**:
   ```bash
   # 檢查網關網絡
   docker network inspect dev_gateway
   
   # 如果不存在，創建網絡
   docker network create dev_gateway
   ```

2. **啓動網關服務**:
   ```bash
   # 通過軟鏈接進入網關目錄
   cd dev-gateway
   
   # 啓動網關
   docker-compose up -d
   
   # 查看狀態
   docker-compose ps
   
   # 查看日誌
   docker-compose logs -fdeactivate
   
   ```

3. **配置項目容器連接網關網絡**:
   ```bash
   # 連接前端容器到網關網絡
   docker network connect dev_gateway <project-frontend-container-name>
   
   # 連接後端容器到網關網絡（如需要）
   docker network connect dev_gateway <project-backend-container-name>
   
   # 例如：論壇項目
   docker network connect dev_gateway forum-frontend
   docker network connect dev_gateway forum-backend
   ```

4. **修改網關 Nginx 配置**:
   ```bash
   # 編輯網關配置文件
   cd dev-gateway
   # 或使用軟鏈接
   # 編輯 nginx.conf 文件
   ```
   
   **配置要求**:
   - 使用變量延遲解析，避免容器未啓動時網關啓動失敗
   - 在 `server` 塊內使用 `set` 定義變量，不能在 `http` 塊頂層定義
   - 必須配置 DNS resolver: `resolver 127.0.0.11 valid=30s;`
   - 詳細配置方式請參考：`dev-gateway/網關配置與問題解決.md`

5. **重新加載網關配置**:
   ```bash
   # 測試配置
   docker exec dev-gateway nginx -t
   
   # 重新加載配置（不停機）
   docker exec dev-gateway nginx -s reload
   
   # 或重啓網關
   cd dev-gateway && docker-compose restart
   ```

**網關配置文檔位置**:
- 詳細配置說明：`dev-gateway/網關配置與問題解決.md`
- 項目使用說明：`網關使用說明.md`

**注意事項**:
- 1. **網關必須先啓動**:
  - 在啓動項目容器前，確保網關已運行
  - 網關可以獨立啓動，不依賴項目容器

- 2. **容器必須連接到網關網絡**:
  - 前端容器必須連接到 `dev_gateway` 網絡才能被網關訪問
  - 可以通過 `docker-compose.yml` 配置自動連接，或手動執行 `docker network connect`

- 3. **配置修改後必須重載**:
  - 修改 `nginx.conf` 後必須測試配置並重載
  - 使用 `nginx -s reload` 實現零停機更新

- 4. **訪問路徑配置**:
  - 項目通過路徑前綴訪問（如 `/forum`、`/shop`）
  - 前端應用必須配置相應的 `base` 路徑（Vite: `base: '/forum/'`）
  - React Router 必須配置 `basename` 與網關路徑前綴一致

**故障排查**:
- 查看網關日誌：`cd dev-gateway && docker-compose logs -f`
- 檢查容器網絡連接：`docker network inspect dev_gateway`
- 測試網關訪問：`curl http://localhost/`
- 詳細故障排查請參考：`dev-gateway/網關配置與問題解決.md`
